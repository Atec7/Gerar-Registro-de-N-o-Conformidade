<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>N√£o Conformidade - SGT</title>

<!-- Libs -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f5f7fa; --fg:#2c3e50; --card:#fff; --accent:#3498db; --accent-2:#22c55e; --border:#d0d7de; --muted:#8aa0b3;
}
.dark{
  --bg:#0f172a; --fg:#e6edf3; --card:#111827; --accent:#2980b9; --accent-2:#22c55e; --border:#30363d; --muted:#9aa8b5;
}
*{box-sizing:border-box}
body{font-family:Segoe UI,system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:20px;background:var(--bg);color:var(--fg);transition:.2s}
h1{margin:0 0 6px;text-align:center;font-size:26px}
.subtitle{margin:0 0 16px;text-align:center;color:var(--muted);font-size:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 18px}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.08)}
.btn.secondary{background:#6b7280}
.btn.warning{background:#ef4444}
.btn.success{background:var(--accent-2)}
.btn:disabled{opacity:.6;cursor:not-allowed}
input,select{border:1px solid var(--border);background:var(--card);widt:100%; color:var(--fg);border-radius:10px;padding:10px;font-size:14px;box-shadow:0 1px 2px rgba(0,0,0,.04) inset}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 14px rgba(0,0,0,.05)}
.table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border);background:var(--card)}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
th{position:sticky;top:0;background:var(--card);font-weight:800;user-select:none;cursor:pointer}
th.sortable:hover{background:rgba(0,0,0,.03)}
tr:hover td{background:rgba(0,0,0,.02)}
.kpis{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:14px}
.kpi-box{padding:10px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.right{display:flex;justify-content:flex-end}
.row-actions{display:flex;gap:6px}
.toast{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.2);display:none;z-index:9999;font-weight:800}
.toast.show{display:block}
.switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
.switch input{appearance:none;width:42px;height:24px;border-radius:999px;background:#cbd5e1;position:relative;outline:none;transition:.2s}
.switch input:checked{background:#22c55e}
.switch input::after{content:"";width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:.2s}
.switch input:checked::after{left:21px}
.helper{font-size:12px;color:var(--muted)}
.badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-weight:800;font-size:12px}
.badge.VALIDADA{background:#dcfce7;color:#166534}
.badge.REJEITADA{background:#fee2e2;color:#991b1b}
.badge.JUSTIFICADA{background:#fef9c3;color:#854d0e}
.badge.INATIVADA{background:#e5e7eb;color:#111827}

#relatorio{width:900px;margin:auto;background:#fff;color:#000;border:2px solid #000;border-radius:10px;padding:24px}
#relatorio .logo{text-align:center;margin-bottom:12px}
#relatorio h2{text-align:center;margin:8px 0 14px}
#relatorio .rodape{text-align:center;margin-top:18px;padding-top:8px;border-top:1px solid #cbd5e1;font-size:12px}
  textarea {
  border: 1px solid var(--border);
  background: var(--card);
  width: 100%;
  color: var(--fg);
  border-radius: 10px;
  padding: 10px;
  font-size: 20px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, .04) inset;
  resize: vertical;
  min-height: 60px;
}

</style>
</head>
<body>

<h1>Gerar Registro de N√£o Conformidade</h1>
<p class="subtitle"><i>Arnaldo S. Lima ‚Äî todos os direitos reservados 2025</i></p>

<div class="toolbar">
  <label class="switch">
    <input id="chkTema" type="checkbox"><span>üåô Tema escuro</span>
  </label>
  <label class="switch">
    <input id="chkAutoRelatorio" type="checkbox" checked><span>üìÑ Gerar relat√≥rio ao salvar</span>
  </label>
  <button class="btn" id="btnExportCsv">Exportar CSV</button>
  <button class="btn" id="btnBackup">Backup JSON</button>
  <button class="btn" id="btnRestore">Restaurar JSON</button>
  <button class="btn warning" id="btnLimpar">Limpar Tudo</button>
</div>

<form id="form" class="card">
  <div class="form-row">
    <input id="ss" placeholder="SS" required>
    <input id="data" placeholder="Data (DD/MM/AAAA)" required>
    <input id="equipe" placeholder="Equipe (prefixo EQTL)" required>
  </div>
  <div class="form-row">
    <input id="endereco" placeholder="Endere√ßo" required>
    <input id="local" placeholder="Local da Execu√ß√£o" required>
    <select id="supervisor" required>
      <option value="">Supervisor</option>
      <option>ACACIO SOUZA</option>
      <option>JOSIMAR MONTEIRO</option>
      <option>RODRIGO COSTA</option>
      <option>GUSTAVO SAVIANE</option>
      <option>FERNANDO VENCESLAU</option>
      <option>ROMARIO PEREIRA</option>
    </select>
  </div>
  <div class="form-row">
  <input id="strike" placeholder="Strike" required>
  <input id="servicos" placeholder="Servi√ßos" required>
  <textarea id="orientacao" placeholder="Orienta√ß√£o do I&P" required></textarea>
</div>
<div class="form-row">
  <textarea id="os" placeholder="Ordem de Servi√ßo" required></textarea>
  <textarea id="rejeicao" placeholder="Rejei√ß√£o da Equatorial" required></textarea>
  <input id="valor" placeholder="Valor do Servi√ßo (ex: 1234,56)" required>
</div>

  <div class="form-row">
    <input id="vencimento" placeholder="Data de Vencimento (DD/MM/AAAA)" required>
    <input id="referencia" placeholder="N¬∫ Poste/Trafo/Posto/Refer√™ncia" required>
  </div>
  <div class="form-row">
  <select id="status" required>
    <option value="">Status</option>
    <option value="VALIDADA">VALIDADA</option>
    <option value="REJEITADA">REJEITADA</option>
    <option value="JUSTIFICADA">JUSTIFICADA</option>
    <option value="INATIVADA">INATIVADA</option>
  </select>
</div>

  <div class="right">
    <button class="btn success" type="submit">Registrar</button>
  </div>
  <div class="helper">Todos os campos s√£o obrigat√≥rios. Datas: DD/MM/AAAA. Valor: 0,00</div>
</form>

<div class="card">
  <div class="grid-2">
    <div class="flex">
      <input id="busca" placeholder="üîé Buscar em todos os campos...">
      <input id="dataInicio" placeholder="Data in√≠cio (DD/MM/AAAA)">
      <input id="dataFim" placeholder="Data fim (DD/MM/AAAA)">
      <select id="filtroStatus">
        <option value="">Todos os Status</option>
        <option value="VALIDADA">VALIDADA</option>
        <option value="REJEITADA">REJEITADA</option>
        <option value="JUSTIFICADA">JUSTIFICADA</option>
        <option value="INATIVADA">INATIVADA</option>
      </select>
    </div>
    <div class="right small">
      <div>Exibidos: <b id="totalExibidos">0</b> | Total geral: <b id="totalGeral">0</b></div>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:10px">
    <table id="tabela">
      <thead><tr id="thead-row"></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="grid-2" style="margin-top:10px">
    <div class="small">Soma dos valores exibidos: <b id="somaExibida">R$ 0,00</b></div>
    <div class="small right">‚ö†Ô∏è Valor em risco (exibidos, n√£o VALIDADA): <b id="valorRisco">R$ 0,00</b></div>
  </div>
</div>

<h2 style="margin:18px 0 10px">üìä Indicadores (KPIs)</h2>
<div class="kpis">
  <div class="card kpi-box"><canvas id="chartEquipes" height="150"></canvas></div>
  <div class="card kpi-box"><canvas id="chartStatus" height="150"></canvas></div>
</div>

<!-- Relat√≥rio (canvas invis√≠vel) -->
<div id="relatorio" class="card" style="display:none;background:#fff;color:#000">
  <div class="logo">
    <img src="https://via.placeholder.com/220x64?text=LOGO" alt="Logo da Empresa"/>
  </div>
  <h2>RELAT√ìRIO DE N√ÉO CONFORMIDADE</h2>
  <div id="relatorio-conteudo"></div>
  <div class="rodape">
    <p>Relat√≥rio gerado em: <span id="dataRelatorio"></span></p>
    <p>Ger√™ncia de Servi√ßos T√©cnicos e Comerciais & Informa√ß√£o e Performance</p>
  </div>
</div>

<div id="toast" class="toast">Pronto!</div>

<script type="module">
/* Firebase (ESM via CDN) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* Config do seu projeto */
const firebaseConfig = {
  apiKey: "AIzaSyCSeSmkMM_4-NlLv8Js_ODwA4H372yq48k",
  authDomain: "rnc-sgt.firebaseapp.com",
  projectId: "rnc-sgt",
  storageBucket: "rnc-sgt.firebasestorage.app",
  messagingSenderId: "500336948308",
  appId: "1:500336948308:web:a6448b9141974f542ce9c1",
  measurementId: "G-LB9EQPJRQ1",
  databaseURL: "https://rnc-sgt-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

window.addEventListener('DOMContentLoaded', () => {
  // ======= COLUNAS (ordem fixa) =======
  const COLS = [
    {key:'ss', label:'SS', type:'text'},
    {key:'data', label:'Data', type:'date'},
    {key:'equipe', label:'Equipe', type:'text'},
    {key:'endereco', label:'Endere√ßo', type:'text'},
    {key:'local', label:'Execu√ß√£o', type:'text'},
    {key:'supervisor', label:'Supervisor', type:'text'},
    {key:'strike', label:'Strike', type:'text'},
    {key:'servicos', label:'Servi√ßos', type:'text'},
    {key:'orientacao', label:'Orienta√ß√£o do I&P', type:'text'},
    {key:'os', label:'OS', type:'text'},
    {key:'rejeicao', label:'Rejei√ß√£o', type:'text'},
    {key:'valor', label:'Valor', type:'currency'},
    {key:'vencimento', label:'Vencimento', type:'date'},
    {key:'referencia', label:'Refer√™ncia', type:'text'},
    {key:'status', label:'Status', type:'status'}
  ];

  // ======= ESTADO =======
  let registros = [];                        // agora somente em mem√≥ria
  let sortKey = loadLS('sortKey', 'data');   // prefer√™ncias continuam no localStorage
  let sortAsc = loadLS('sortAsc', true);

  const els = {
    form: document.getElementById('form'),
    tbody: document.querySelector('#tabela tbody'),
    theadRow: document.getElementById('thead-row'),
    totalExibidos: document.getElementById('totalExibidos'),
    totalGeral: document.getElementById('totalGeral'),
    somaExibida: document.getElementById('somaExibida'),
    valorRisco: document.getElementById('valorRisco'),
    busca: document.getElementById('busca'),
    dataInicio: document.getElementById('dataInicio'),
    dataFim: document.getElementById('dataFim'),
    filtroStatus: document.getElementById('filtroStatus'),
    chkTema: document.getElementById('chkTema'),
    chkAutoRelatorio: document.getElementById('chkAutoRelatorio'),
    toast: document.getElementById('toast')
  };

  // ======= Prefer√™ncias =======
  if(loadLS('tema', 'light') === 'dark'){ document.body.classList.add('dark'); els.chkTema.checked = true; }
  els.busca.value = loadLS('busca', '');
  els.dataInicio.value = loadLS('dataInicio', '');
  els.dataFim.value = loadLS('dataFim', '');
  els.filtroStatus.value = loadLS('filtroStatus', '');

  renderHeader();

  // ======= Firebase: assinar altera√ß√µes em tempo real =======
  const dbRef = ref(db, 'registros');
  onValue(dbRef, snap => {
    const val = snap.val() || {};
    registros = Object.entries(val).map(([id, r]) => ({ id, ...r }));
    // garante chaves faltantes para evitar undefined
    registros.forEach(r => COLS.forEach(c => { if(!(c.key in r)) r[c.key] = ''; }));
    render();
  });

  // ======= Eventos toolbar =======
  document.getElementById('btnExportCsv').addEventListener('click', exportCSV);
  document.getElementById('btnBackup').addEventListener('click', backupJSON);
  document.getElementById('btnRestore').addEventListener('click', restoreJSON);
  document.getElementById('btnLimpar').addEventListener('click', limparTudo);

  els.busca.addEventListener('input', () => { saveLS('busca', els.busca.value); render(); });
  [els.dataInicio, els.dataFim].forEach(i => i.addEventListener('input', () => { saveLS(i.id, i.value); render(); }));
  els.filtroStatus.addEventListener('change', () => { saveLS('filtroStatus', els.filtroStatus.value); render(); });
  els.chkTema.addEventListener('change', () => { document.body.classList.toggle('dark', els.chkTema.checked); saveLS('tema', els.chkTema.checked?'dark':'light'); });

  // ======= Submit do formul√°rio =======
  els.form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const r = readForm();
    if(!r) return;

    try{
      const newRef = push(dbRef);
      await set(newRef, r);
      if(els.chkAutoRelatorio.checked) gerarImagemRelatorio(r);
      limparFormulario();
      toast('Registro salvo' + (els.chkAutoRelatorio.checked?' e relat√≥rio gerado!':'!'));
    }catch(err){
      console.error(err);
      toast('Falha ao salvar no Firebase.');
    }
  });

  // ======= Header com sort =======
  function renderHeader(){
    els.theadRow.innerHTML = '';
    COLS.forEach(c=>{
      const th = document.createElement('th');
      th.textContent = c.label + (sortKey===c.key ? (sortAsc?' ‚ñ≤':' ‚ñº'):'');
      th.classList.add('sortable');
      th.title = 'Clique para ordenar';
      th.addEventListener('click', ()=>{
        if(sortKey===c.key) sortAsc=!sortAsc; else {sortKey=c.key; sortAsc=true;}
        saveLS('sortKey', sortKey); saveLS('sortAsc', sortAsc);
        renderHeader(); render();
      });
      els.theadRow.appendChild(th);
    });
    const thA = document.createElement('th'); thA.textContent='A√ß√µes'; els.theadRow.appendChild(thA);
  }

  // ======= Filtro + render =======
  function getFiltered(){
    let rows = [...registros];
    const q = (els.busca.value||'').toLowerCase();
    const di = normalizeDate(els.dataInicio.value);
    const df = normalizeDate(els.dataFim.value);
    const fs = els.filtroStatus.value;

    if(q) rows = rows.filter(r => COLS.some(c => String(r[c.key]||'').toLowerCase().includes(q)));
    if(isValidDate(di)){ const min = parseDateBR(di).getTime(); rows = rows.filter(r => parseDateBR(r.data)?.getTime()>=min); }
    if(isValidDate(df)){ const max = parseDateBR(df).getTime(); rows = rows.filter(r => parseDateBR(r.data)?.getTime()<=max); }
    if(fs) rows = rows.filter(r => r.status===fs);

    rows.sort((a,b)=>compare(a,b,sortKey,sortAsc));
    return rows;
  }

  function render(){
    const rows = getFiltered();
    els.tbody.innerHTML = '';

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      COLS.forEach(c=>{
        const td = document.createElement('td');
        if(c.key==='status'){
          const b = document.createElement('span');
          b.className = 'badge ' + r.status;
          b.textContent = r.status;
          td.appendChild(b);
        } else if(c.key==='valor'){
          td.textContent = formatBRL(parseBRL(r.valor)||0);
        } else {
          td.textContent = r[c.key];
        }
        tr.appendChild(td);
      });

      const tdA = document.createElement('td');
      tdA.className = 'row-actions';

      // Bot√£o relat√≥rio
      const btnRel = document.createElement('button');
      btnRel.type = 'button';
      btnRel.className = 'btn secondary';
      btnRel.textContent = 'üìÑ Relat√≥rio';
      btnRel.addEventListener('click', () => gerarImagemRelatorio(r));
      tdA.appendChild(btnRel);

      // Select de status (edita direto no Firebase)
      const selStatus = document.createElement('select');
      ['VALIDADA','REJEITADA','JUSTIFICADA','INATIVADA'].forEach(st => {
        const opt = document.createElement('option');
        opt.value = st;
        opt.textContent = st;
        if (r.status === st) opt.selected = true;
        selStatus.appendChild(opt);
      });
      selStatus.addEventListener('change', async () => {
        try{
          await update(ref(db, `registros/${r.id}`), { status: selStatus.value });
          toast('Status atualizado!');
        }catch(err){
          console.error(err);
          toast('Falha ao atualizar status.');
          selStatus.value = r.status; // rollback visual
        }
      });
      tdA.appendChild(selStatus);

      tr.appendChild(tdA);
      els.tbody.appendChild(tr);
    });

    els.totalExibidos.textContent = rows.length;
    els.totalGeral.textContent = registros.length;
    updateTotals(rows);
    drawCharts();
  }

  // ======= Leitura/valida√ß√£o do form =======
  function readForm(){
    const r = {};
    for(const c of COLS){
      const el = document.getElementById(c.key);
      r[c.key] = el ? el.value.trim() : '';
    }

    // valida√ß√µes simples
    const camposVazios = COLS.filter(c=>!r[c.key]);
    if(camposVazios.length){ toast('Preencha todos os campos.'); return null; }

    if(!isValidDate(r.data) || !isValidDate(r.vencimento)){
      toast('Datas devem estar no formato DD/MM/AAAA.'); return null;
    }
    if(isNaN(parseBRL(r.valor))){
      toast('Valor inv√°lido. Use 0,00 (ex: 1.234,56).'); return null;
    }
    return r;
  }

  // ======= Relat√≥rio PNG =======
  function gerarImagemRelatorio(r){
    const div = document.createElement('div');
    div.style.fontFamily='Arial, sans-serif';
    div.style.padding='24px';
    div.style.width='960px';
    div.style.background='#ffffff';
    div.style.color='#000000';
    div.style.border='2px solid #000';

    const header = `
      <div style="text-align:center;margin-bottom:8px">
        <img src="https://via.placeholder.com/220x64?text=LOGO" alt="Logo"/>
      </div>
      <h2 style="text-align:center;margin:8px 0 16px">RELAT√ìRIO DE N√ÉO CONFORMIDADE</h2>
    `;

    const grid = COLS.map(c=>`
      <div style="margin:6px 0">
        <strong>${c.label}:</strong> ${escapeHtml(c.key==='valor' ? formatBRL(parseBRL(r[c.key])||0) : r[c.key])}
      </div>`).join('');

    const footer = `
      <div style="margin-top:14px;padding-top:8px;border-top:1px solid #cbd5e1;font-size:12px;text-align:center">
        Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}
      </div>`;

    div.innerHTML = header + grid + footer;
    document.body.appendChild(div);

    html2canvas(div,{scale:2}).then(canvas=>{
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `NAO_CONFORMIDADE_SS_${sanitizeFile(r.ss)}.png`;
      a.click();
      window.open(dataUrl, '_blank');
      document.body.removeChild(div);
    });
  }

  // ======= Totais =======
  function updateTotals(rows){
    const soma = rows.reduce((acc,r)=>acc+(parseBRL(r.valor)||0),0);
    const risco = rows.reduce((acc,r)=> r.status!=='VALIDADA' ? acc+(parseBRL(r.valor)||0):acc,0);
    els.somaExibida.textContent = formatBRL(soma);
    els.valorRisco.textContent = formatBRL(risco);
  }

  // ======= Limpar =======
  function limparFormulario(){ COLS.forEach(c=>{ const el=document.getElementById(c.key); if(el) el.value=''; }); }
  async function limparTudo(){
    const opt = confirm('Apagar TUDO do BANCO DE DADOS? √â S√âRIO ISSOü§®!!! ISSO S√ì DEVE SER FEITO UMA VEZ POR M√äS E SE J√Å TIVER EXPORTADO ALGUM ARQUIVO DE RECUPERA√á√ÉO!');
    if(!opt) return;
    try{
      await remove(dbRef);
      toast('Todos os registros foram removidos.');
    }catch(err){
      console.error(err);
      toast('Falha ao remover registros.');
    }
  }

  // ======= Exporta√ß√µes =======
  function exportCSV(){
    if(!registros.length){ toast('Nada para exportar.'); return; }
    const header = COLS.map(c=>`"${c.label}"`).join(',')+'\n';
    const lines = registros.map(r=>COLS.map(c=>`"${String(c.key==='valor'?formatBRL(parseBRL(r[c.key])||0):r[c.key]).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadBlob(header+lines, 'registros_nao_conformidade.csv', 'text/csv;charset=utf-8;');
    toast('CSV exportado!');
  }
  function backupJSON(){
    downloadBlob(JSON.stringify(registros,null,2), 'backup_registros.json', 'application/json');
    toast('Backup gerado!');
  }
  function restoreJSON(){
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json,application/json';
    input.onchange = () => {
      const fr = new FileReader();
      fr.onload = async () => {
        try{
          const data = JSON.parse(fr.result);
          if(!Array.isArray(data)) throw new Error('JSON inv√°lido');

          // Insere cada item no Firebase (gera novas chaves)
          for(const item of data){
            const r = {};
            COLS.forEach(c => { r[c.key] = (item[c.key] ?? '').toString(); });
            // valida√ß√µes b√°sicas (mant√©m comportamento)
            if(!r.data || !r.vencimento || isNaN(parseBRL(r.valor))) continue;
            await set(push(dbRef), r);
          }
          toast('JSON carregado e inserido no BANCO DE DADOS!üöÄüòé');
        }catch(e){ alert('Falha ao carregar JSON: '+e.message); }
      };
      fr.readAsText(input.files[0]);
    };
    input.click();
  }
  function downloadBlob(text, filename, type){
    const blob = new Blob([text], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ======= Utils =======
  function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),2500); }
  function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function loadLS(k,d){ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):d; }catch{ return d; } }

  function parseBRL(v){
    if(v==null) return 0;
    const s = String(v).trim().replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3}(?:\D|$))/g,'').replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n)?NaN:n;
  }
  function formatBRL(n){ const x = Number(n)||0; return x.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

  function normalizeDate(v){ if(!v) return ''; if(v.includes('-')){ const [y,m,d]=v.split('-'); if(d&&m&&y) return `${d}/${m}/${y}`; } return v; }
  function isValidDate(str){ if(!str) return false; const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(str); if(!m) return false; const d=+m[1], mo=+m[2]-1, y=+m[3]; const dt=new Date(y,mo,d); return dt.getFullYear()===y && dt.getMonth()===mo && dt.getDate()===d; }
  function parseDateBR(str){ if(!isValidDate(str)) return null; const [d,m,y]=str.split('/').map(Number); return new Date(y,m-1,d); }
  function compare(a,b,key,asc){
    let va=a[key], vb=b[key];
    const col = COLS.find(c=>c.key===key);
    if(key==='valor'){ va=parseBRL(va)||0; vb=parseBRL(vb)||0; }
    else if(col?.type==='date'){ va=parseDateBR(va)?.getTime()||0; vb=parseDateBR(vb)?.getTime()||0; }
    else { va=String(va||'').toLowerCase(); vb=String(vb||'').toLowerCase(); }
    const res = va<vb?-1:va>vb?1:0;
    return asc?res:-res;
  }
  function escapeHtml(t){ return String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
  function sanitizeFile(t){ return String(t||'').replace(/[^\w.-]+/g,'_'); }

  // ======= Gr√°ficos =======
  function drawCharts(){
    if(typeof Chart==='undefined') return;

    // STATUS (pizza)
    const statusAgg = {'VALIDADA':0,'REJEITADA':0,'JUSTIFICADA':0,'INATIVADA':0};
    registros.forEach(r=>{ if(statusAgg[r.status]!=null) statusAgg[r.status]+= (parseBRL(r.valor)||0); });
    const stx = document.getElementById('chartStatus').getContext('2d');
    if(window.statusChart) window.statusChart.destroy();
    window.statusChart = new Chart(stx, {
      type:'pie',
      data:{ labels:Object.keys(statusAgg), datasets:[{ data:Object.values(statusAgg) }] },
      options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });

    // EQUIPES (barra: soma de valores)
    const byEquipe = {};
    registros.forEach(r=>{ const k=r.equipe||'‚Äî'; byEquipe[k]=(byEquipe[k]||0)+(parseBRL(r.valor)||0); });
    const eqx = document.getElementById('chartEquipes').getContext('2d');
    if(window.eqChart) window.eqChart.destroy();
    window.eqChart = new Chart(eqx, {
      type:'bar',
      data:{ labels:Object.keys(byEquipe), datasets:[{ label:'Soma por equipe (R$)', data:Object.values(byEquipe) }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ autoSkip:false, maxRotation:45, minRotation:0 } } } }
    });
  }
});
</script>


</body>
</html>
