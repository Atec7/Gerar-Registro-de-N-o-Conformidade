<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>N√£o Conformidade - SGT</title>

<!-- Libs corretas -->
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f5f7fa; --fg:#2c3e50; --card:#fff; --accent:#3498db; --accent-2:#2ecc71; --border:#d0d7de; --muted:#8aa0b3;
}
.dark{
  --bg:#111; --fg:#e6edf3; --card:#1b1f24; --accent:#2980b9; --accent-2:#22c55e; --border:#30363d; --muted:#9aa8b5;
}
*{box-sizing:border-box}
body{
  font-family:Segoe UI,system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif;
  margin:0; padding:20px; background:var(--bg); color:var(--fg); transition:.2s;
}
h1{margin:0 0 6px; text-align:center; font-size:26px}
.subtitle{margin:0 0 16px; text-align:center; color:var(--muted); font-size:12px}
.toolbar{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:10px 0 18px}
.btn{
  background:var(--accent); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.btn.secondary{ background:#6b7280 }
.btn.warning{ background:#ef4444 }
.btn.success{ background:var(--accent-2) }
.btn:disabled{opacity:.6; cursor:not-allowed}
input,select{
  border:1px solid var(--border); background:var(--card); color:var(--fg); border-radius:10px; padding:10px; font-size:14px;
  box-shadow:0 1px 2px rgba(0,0,0,.04) inset;
}
.form-row{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 14px rgba(0,0,0,.05);
}
.table-wrap{overflow:auto; border-radius:12px; border:1px solid var(--border); background:var(--card)}
table{width:100%; border-collapse:collapse; font-size:13px}
th,td{padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:top}
th{
  position:sticky; top:0; background:var(--card); font-weight:700; user-select:none; cursor:pointer;
}
th.sortable:hover{background:rgba(0,0,0,.03)}
tr:hover td{background:rgba(0,0,0,.02)}
.badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; font-weight:700; font-size:12px}
.badge.validada{background:#dcfce7; color:#166534}
.badge.rejeitada{background:#fee2e2; color:#991b1b}
.badge.justificada{background:#fef9c3; color:#854d0e}
.badge.inativada{background:#e5e7eb; color:#111827}
.kpis{display:grid; grid-template-columns:repeat(2,minmax(260px,1fr)); gap:14px}
.kpi-box{padding:10px}
.grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.small{font-size:12px; color:var(--muted)}
.flex{display:flex; gap:8px; flex-wrap:wrap}
.right{display:flex; justify-content:flex-end}
.row-actions{display:flex; gap:6px}
.toast{
  position:fixed; bottom:18px; right:18px; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px;
  box-shadow:0 6px 24px rgba(0,0,0,.2); display:none; z-index:9999; font-weight:700;
}
.switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer}
.switch input{appearance:none; width:42px; height:24px; border-radius:999px; background:#cbd5e1; position:relative; outline:none; transition:.2s}
.switch input:checked{background:#22c55e}
.switch input::after{
  content:""; width:18px; height:18px; background:#fff; border-radius:50%; position:absolute; top:3px; left:3px; transition:.2s;
}
.switch input:checked::after{left:21px}
.helper{font-size:12px; color:var(--muted)}
#relatorio{width:900px; margin:auto; background:#fff; color:#000; border:2px solid #000; border-radius:10px; padding:24px}
#relatorio .logo{text-align:center; margin-bottom:12px}
#relatorio h2{text-align:center; margin:8px 0 14px}
#relatorio .rodape{text-align:center; margin-top:18px; padding-top:8px; border-top:1px solid #cbd5e1; font-size:12px}
</style>
</head>
<body>

<h1>Gerar Registro de N√£o Conformidade</h1>
<p class="subtitle"><i>Arnaldo S. Lima ‚Äî todos os direitos reservados 2025</i></p>

<div class="toolbar">
  <label class="switch">
    <input id="chkTema" type="checkbox"><span>üåô Tema escuro</span>
  </label>
  <label class="switch">
    <input id="chkAutoRelatorio" type="checkbox" checked><span>üìÑ Gerar relat√≥rio ao salvar</span>
  </label>
  <button class="btn" id="btnExportCsv">Exportar CSV</button>
  <button class="btn" id="btnBackup">Backup JSON</button>
  <button class="btn" id="btnRestore">Restaurar JSON</button>
  <button class="btn warning" id="btnLimpar">Limpar Tudo</button>
</div>

<form id="form" class="card">
  <div class="form-row">
    <input id="ss" placeholder="SS" required>
    <input id="data" placeholder="Data (DD/MM/AAAA)" required>
    <input id="equipe" placeholder="Equipe (prefixo EQTL)" required>
  </div>
  <div class="form-row">
    <input id="endereco" placeholder="Endere√ßo" required>
    <input id="local" placeholder="Local da Execu√ß√£o" required>
    <select id="supervisor" required>
      <option value="">Supervisor</option>
      <option>ACACIO SOUZA</option>
      <option>JOSE VICTOR</option>
      <option>LEANDRO FREITAS</option>
      <option>RODRIGO COSTA</option>
      <option>GUSTAVO SAVIANE</option>
      <option>FERNANDO VENCESLAU</option>
      <option>ROMARIO PEREIRA</option>
    </select>
  </div>
  <div class="form-row">
    <input id="strike" placeholder="Strike" required>
    <input id="servicos" placeholder="Servi√ßos" required>
    <input id="orientacao" placeholder="Orienta√ß√£o do I&P" required>
  </div>
  <div class="form-row">
    <input id="os" placeholder="Ordem de Servi√ßo" required>
    <input id="rejeicao" placeholder="Rejei√ß√£o da Equatorial" required>
    <input id="valor" placeholder="Valor do Servi√ßo (ex: 1234,56)" required>
  </div>
  <div class="form-row">
    <input id="vencimento" placeholder="Data de Vencimento (DD/MM/AAAA)" required>
    <input id="referencia" placeholder="N¬∫ Poste/Trafo/Posto/Refer√™ncia" required>
  </div>
  <div class="right">
    <button class="btn success" type="submit">Registrar</button>
  </div>
  <div class="helper">Todos os campos s√£o obrigat√≥rios. Datas: DD/MM/AAAA. Valor: 0,00</div>
</form>

<div class="card">
  <div class="grid-2">
    <div class="flex">
      <input id="busca" placeholder="üîé Buscar em todos os campos...">
      <input id="dataInicio" placeholder="Data in√≠cio (DD/MM/AAAA)">
      <input id="dataFim" placeholder="Data fim (DD/MM/AAAA)">
      <select id="filtroStatus">
        <option value="">Todos os Status</option>
        <option value="VALIDADA">VALIDADA</option>
        <option value="REJEITADA">REJEITADA</option>
        <option value="JUSTIFICADA">JUSTIFICADA</option>
        <option value="INATIVADA">INATIVADA</option>
      </select>
    </div>
    <div class="right small">
      <div>Exibidos: <b id="totalExibidos">0</b> | Total geral: <b id="totalGeral">0</b></div>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:10px">
    <table id="tabela">
      <thead>
        <tr id="thead-row"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="grid-2" style="margin-top:10px">
    <div class="small">Soma dos valores exibidos: <b id="somaExibida">R$ 0,00</b></div>
    <div class="small right">‚ö†Ô∏è Valor em risco (exibidos, n√£o VALIDADA): <b id="valorRisco">R$ 0,00</b></div>
  </div>
</div>

<h2 style="margin:18px 0 10px">üìä Indicadores (KPIs)</h2>
<div class="kpis">
  <div class="card kpi-box">
    <canvas id="chartEquipes" height="150"></canvas>
  </div>
  <div class="card kpi-box">
    <canvas id="chartStatus" height="150"></canvas>
  </div>
</div>

<!-- Relat√≥rio (canvas) -->
<div id="relatorio" class="card" style="display:none; background:#fff; color:#000">
  <div class="logo">
    <img src="https://via.placeholder.com/220x64?text=LOGO" alt="Logo da Empresa"/>
  </div>
  <h2>RELAT√ìRIO DE N√ÉO CONFORMIDADE</h2>
  <div id="relatorio-conteudo"></div>
  <div class="rodape">
    <p>Relat√≥rio gerado em: <span id="dataRelatorio"></span></p>
    <p>Ger√™ncia de Servi√ßos T√©cnicos e Comerciais & Informa√ß√£o e Performance</p>
  </div>
</div>

<div id="toast" class="toast">Pronto!</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  // ======= Modelo de colunas (ordem fixa) =======
  const COLS = [
    {key:'ss', label:'SS', type:'text'},
    {key:'data', label:'Data', type:'date'},
    {key:'equipe', label:'Equipe', type:'text'},
    {key:'endereco', label:'Endere√ßo', type:'text'},
    {key:'local', label:'Execu√ß√£o', type:'text'},
    {key:'supervisor', label:'Supervisor', type:'text'},
    {key:'strike', label:'Strike', type:'text'},
    {key:'servicos', label:'Servi√ßos', type:'text'},
    {key:'orientacao', label:'Orienta√ß√£o do I&P', type:'text'},
    {key:'os', label:'OS', type:'text'},
    {key:'rejeicao', label:'Rejei√ß√£o', type:'text'},
    {key:'valor', label:'Valor', type:'currency'},
    {key:'vencimento', label:'Vencimento', type:'date'},
    {key:'referencia', label:'Refer√™ncia', type:'text'},
    {key:'status', label:'Status', type:'status'}
  ];

  // ======= Estado =======
  let registros = loadLS('registros', []);
  let sortKey = loadLS('sortKey', 'data');
  let sortAsc = loadLS('sortAsc', true);

  const els = {
    tbody: document.querySelector('#tabela tbody'),
    theadRow: document.getElementById('thead-row'),
    totalExibidos: document.getElementById('totalExibidos'),
    totalGeral: document.getElementById('totalGeral'),
    somaExibida: document.getElementById('somaExibida'),
    valorRisco: document.getElementById('valorRisco'),
    busca: document.getElementById('busca'),
    dataInicio: document.getElementById('dataInicio'),
    dataFim: document.getElementById('dataFim'),
    filtroStatus: document.getElementById('filtroStatus'),
    chkTema: document.getElementById('chkTema'),
    chkAutoRelatorio: document.getElementById('chkAutoRelatorio'),
    toast: document.getElementById('toast')
  };

  // Restaurar prefer√™ncias
  if(loadLS('tema', 'light') === 'dark') {
    document.body.classList.add('dark');
    els.chkTema.checked = true;
  }
  els.busca.value = loadLS('busca', '');
  els.dataInicio.value = loadLS('dataInicio', '');
  els.dataFim.value = loadLS('dataFim', '');
  els.filtroStatus.value = loadLS('filtroStatus', '');

  // ======= Cabe√ßalho com sort =======
  renderHeader();

  // ======= Eventos b√°sicos =======
  document.getElementById('form').addEventListener('submit', onSubmit);
  document.getElementById('btnExportCsv').addEventListener('click', exportCSV);
  document.getElementById('btnBackup').addEventListener('click', backupJSON);
  document.getElementById('btnRestore').addEventListener('click', restoreJSON);
  document.getElementById('btnLimpar').addEventListener('click', limparTudo);

  els.busca.addEventListener('input', () => {
    saveLS('busca', els.busca.value);
    render();
  });

  [els.dataInicio, els.dataFim].forEach(input => {
    input.addEventListener('input', () => {
      saveLS(input.id, input.value);
      render();
    });
  });

  els.filtroStatus.addEventListener('change', () => {
    saveLS('filtroStatus', els.filtroStatus.value);
    render();
  });

  els.chkTema.addEventListener('change', () => {
    document.body.classList.toggle('dark', els.chkTema.checked);
    saveLS('tema', els.chkTema.checked ? 'dark' : 'light');
  });

  // ======= Render inicial =======
  render();

  // ======= Fun√ß√µes =======

  function onSubmit(e) {
    e.preventDefault();
    const registro = readForm();
    if (!registro) return;

    registro.id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    registro.status = 'VALIDADA';
    registros.push(registro);
    save(true);
    e.target.reset();
    toast('Registro adicionado!');

    if (els.chkAutoRelatorio.checked) {
      gerarRelatorio(registro);
    }
  }

  function readForm() {
    const get = id => document.getElementById(id).value.trim();
    const r = {
      ss: get('ss'),
      data: normalizeDate(get('data')),
      equipe: get('equipe'),
      endereco: get('endereco'),
      local: get('local'),
      supervisor: get('supervisor'),
      strike: get('strike'),
      servicos: get('servicos'),
      orientacao: get('orientacao'),
      os: get('os'),
      rejeicao: get('rejeicao'),
      valor: normalizeBRL(get('valor')),
      vencimento: normalizeDate(get('vencimento')),
      referencia: get('referencia')
    };

    // Valida√ß√£o simples
    const obrigatorios = Object.entries(r).filter(([k, v]) => !v || v === '');
    if (obrigatorios.length) {
      toast('Preencha todos os campos.');
      return null;
    }
    if (!parseDateBR(r.data) || !parseDateBR(r.vencimento)) {
      toast('Datas devem estar em DD/MM/AAAA.');
      return null;
    }
    if (isNaN(parseBRL(r.valor))) {
      toast('Valor inv√°lido. Use formato 0,00');
      return null;
    }
    return r;
  }

  function renderHeader() {
    els.theadRow.innerHTML = '';
    COLS.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c.label;
      th.classList.add('sortable');
      th.style.cursor = 'pointer';
      th.title = 'Clique para ordenar';
      th.addEventListener('click', () => {
        if (sortKey === c.key) {
          sortAsc = !sortAsc;
        } else {
          sortKey = c.key;
          sortAsc = true;
        }
        saveLS('sortKey', sortKey);
        saveLS('sortAsc', sortAsc);
        render();
      });
      els.theadRow.appendChild(th);
    });
    const thActions = document.createElement('th');
    thActions.textContent = 'A√ß√µes';
    els.theadRow.appendChild(thActions);
  }

  function getFiltered() {
    let filtered = [...registros];
    const q = (els.busca.value || '').toLowerCase();
    const di = normalizeDate(els.dataInicio.value);
    const df = normalizeDate(els.dataFim.value);
    const fs = els.filtroStatus.value;

    if (q) {
      filtered = filtered.filter(r =>
        COLS.some(c => String(r[c.key] || '').toLowerCase().includes(q))
      );
    }

    if (di && parseDateBR(di)) {
      const dMin = parseDateBR(di).getTime();
      filtered = filtered.filter(r => {
        const d = parseDateBR(r.data);
        return d && d.getTime() >= dMin;
      });
    }

    if (df && parseDateBR(df)) {
      const dMax = parseDateBR(df).getTime();
      filtered = filtered.filter(r => {
        const d = parseDateBR(r.data);
        return d && d.getTime() <= dMax;
      });
    }

    if (fs) {
      filtered = filtered.filter(r => r.status === fs);
    }

    filtered.sort((a, b) => compare(a, b, sortKey, sortAsc));
    return filtered;
  }

  function render() {
    const rows = getFiltered();
    els.tbody.innerHTML = '';

    rows.forEach(r => {
      const tr = document.createElement('tr');

      COLS.forEach(c => {
        const td = document.createElement('td');

        if (c.type === 'status') {
          const sel = document.createElement('select');
          ['VALIDADA','REJEITADA','JUSTIFICADA','INATIVADA'].forEach(op => {
            const option = document.createElement('option');
            option.value = op;
            option.textContent = op;
            if (r.status === op) option.selected = true;
            sel.appendChild(option);
          });
          sel.addEventListener('change', () => {
            r.status = sel.value;
            save(false);
            updateTotals(rows);
            drawCharts();
          });
          td.appendChild(sel);
        } else {
          td.contentEditable = true;
          td.spellcheck = false;
          td.textContent = r[c.key];
          td.addEventListener('blur', () => {
            let v = td.textContent.trim();

            if (c.type === 'currency') {
              v = normalizeBRL(v);
              if (isNaN(parseBRL(v))) {
                toast('Valor inv√°lido');
                td.textContent = r[c.key];
                return;
              }
            }

            if (c.type === 'date') {
              v = normalizeDate(v);
              if (!parseDateBR(v)) {
                toast('Data inv√°lida');
                td.textContent = r[c.key];
                return;
              }
            }

            r[c.key] = v;
            save(false);

            if (['valor', 'status', 'data'].includes(c.key)) {
              updateTotals(rows);
              drawCharts();
            }
          });
          td.addEventListener('keydown', (e) => {
            // Evitar quebra de linha em cells edit√°veis
            if (e.key === 'Enter') {
              e.preventDefault();
              td.blur();
            }
          });
        }

        tr.appendChild(td);
      });

      // A√ß√µes
      const tdActions = document.createElement('td');
      tdActions.className = 'row-actions';

      const btnRelatorio = document.createElement('button');
      btnRelatorio.type = 'button';
      btnRelatorio.className = 'btn secondary';
      btnRelatorio.textContent = 'üìÑ Relat√≥rio';
      btnRelatorio.title = 'Gerar relat√≥rio';
      btnRelatorio.addEventListener('click', () => gerarRelatorio(r));

      const btnExcluir = document.createElement('button');
      btnExcluir.type = 'button';
      btnExcluir.className = 'btn warning';
      btnExcluir.textContent = 'üóëÔ∏è Excluir';
      btnExcluir.title = 'Excluir registro';
      btnExcluir.addEventListener('click', () => excluir(r.id));

      tdActions.appendChild(btnRelatorio);
      tdActions.appendChild(btnExcluir);

      tr.appendChild(tdActions);
      els.tbody.appendChild(tr);
    });

    els.totalExibidos.textContent = rows.length;
    els.totalGeral.textContent = registros.length;

    updateTotals(rows);
    drawCharts();
  }

  function updateTotals(rows) {
    const soma = rows.reduce((acc, r) => acc + (parseBRL(r.valor) || 0), 0);
    const risco = rows.reduce((acc, r) => r.status !== 'VALIDADA' ? acc + (parseBRL(r.valor) || 0) : acc, 0);
    els.somaExibida.textContent = formatBRL(soma);
    els.valorRisco.textContent = formatBRL(risco);
  }

  function excluir(id) {
    if (!confirm('Deseja excluir este registro?')) return;
    registros = registros.filter(r => r.id !== id);
    save(true);
    toast('Registro exclu√≠do!');
  }

  function exportCSV() {
    if (!registros.length) {
      toast('Nada para exportar');
      return;
    }
    const header = COLS.map(c => `"${c.label}"`).join(',') + '\n';
    const lines = registros.map(r =>
      COLS.map(c => `"${String(r[c.key] ?? '').replace(/"/g, '""')}"`).join(',')
    ).join('\n');

    const blob = new Blob([header + lines], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'registros_nao_conformidade.csv';
    a.click();

    toast('CSV exportado!');
  }

  function backupJSON() {
    const blob = new Blob([JSON.stringify(registros, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backup_registros.json';
    a.click();
    toast('Backup gerado!');
  }

  function restoreJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';

  input.onchange = () => {
    const fr = new FileReader();
    fr.onload = () => {
      try {
        const data = JSON.parse(fr.result);
        if (!Array.isArray(data)) throw new Error('JSON inv√°lido');

        // Garante que cada registro tenha um ID
        data.forEach(d => {
          if (!d.id) d.id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
        });

        // Mescla sem duplicar IDs
        const idsExistentes = new Set(registros.map(r => r.id));
        const novos = data.filter(d => !idsExistentes.has(d.id));

        registros = [...registros, ...novos];
        save(true);
        toast(`Backup restaurado! ${novos.length} novos registros adicionados.`);
      } catch (e) {
        alert('Falha ao carregar JSON: ' + e.message);
      }
    };
    fr.readAsText(input.files[0]);
  };

  input.click();
}


  function limparTudo() {
    if (!confirm('Tem certeza que deseja apagar TODOS os registros?')) return;
    registros = [];
    save(true);
    toast('Tudo limpo!');
  }

  function gerarRelatorio(r) {
    const html = `
      <p><strong>SS:</strong> ${escapeHtml(r.ss)}</p>
      <p><strong>Data:</strong> ${escapeHtml(r.data)}</p>
      <p><strong>Equipe:</strong> ${escapeHtml(r.equipe)}</p>
      <p><strong>Endere√ßo:</strong> ${escapeHtml(r.endereco)}</p>
      <p><strong>Local da Execu√ß√£o:</strong> ${escapeHtml(r.local)}</p>
      <p><strong>Supervisor:</strong> ${escapeHtml(r.supervisor)}</p>
      <p><strong>Strike:</strong> ${escapeHtml(r.strike)}</p>
      <p><strong>Servi√ßos:</strong> ${escapeHtml(r.servicos)}</p>
      <p><strong>Orienta√ß√£o do I&P:</strong> ${escapeHtml(r.orientacao)}</p>
      <p><strong>Ordem de Servi√ßo:</strong> ${escapeHtml(r.os)}</p>
      <p><strong>Rejei√ß√£o da Equatorial:</strong> ${escapeHtml(r.rejeicao)}</p>
      <p><strong>Valor do Servi√ßo:</strong> ${formatBRL(parseBRL(r.valor))}</p>
      <p><strong>Data de Vencimento:</strong> ${escapeHtml(r.vencimento)}</p>
      <p><strong>Refer√™ncia:</strong> ${escapeHtml(r.referencia)}</p>
      <p><strong>Status:</strong> ${escapeHtml(r.status)}</p>
    `;
    const win = window.open('', '_blank', 'width=600,height=600,scrollbars=yes');
    win.document.write(`
      <html><head><title>Relat√≥rio de N√£o Conformidade</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        p { margin: 5px 0; }
      </style>
      </head><body>${html}</body></html>
    `);
    win.document.close();
    win.focus();
  }

  // ======= Utils =======
  function toast(msg) {
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 3000);
  }

  function save(autoRender) {
    saveLS('registros', registros);
    if (autoRender) render();
  }

  function saveLS(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
  }

  function loadLS(key, defaultVal) {
    try {
      const val = localStorage.getItem(key);
      return val ? JSON.parse(val) : defaultVal;
    } catch {
      return defaultVal;
    }
  }

  // Formata e normaliza valores brasileiros

  function normalizeBRL(v) {
    if (!v) return '';
    v = v.replace(/\s/g,'').replace(/[^\d,.-]/g,'').replace('.', '').replace(',', '.');
    return v;
  }

  function parseBRL(v) {
    if (!v) return 0;
    v = String(v).replace(/\./g, '').replace(',', '.');
    return parseFloat(v) || 0;
  }

  function formatBRL(v) {
    return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function normalizeDate(v) {
    if (!v) return '';
    // Aceita DD/MM/AAAA ou AAAA-MM-DD e converte para DD/MM/AAAA
    if (v.includes('-')) {
      const [yyyy, mm, dd] = v.split('-');
      if (dd && mm && yyyy) return `${dd}/${mm}/${yyyy}`;
    }
    return v;
  }

  function parseDateBR(str) {
    // Espera DD/MM/AAAA
    if (!str) return null;
    const parts = str.split('/');
    if (parts.length !== 3) return null;
    const d = parseInt(parts[0],10);
    const m = parseInt(parts[1],10)-1;
    const y = parseInt(parts[2],10);
    if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
    return new Date(y,m,d);
  }

  function compare(a, b, key, asc) {
    let va = a[key];
    let vb = b[key];

    if (key === 'valor') {
      va = parseBRL(va);
      vb = parseBRL(vb);
    } else if (COLS.find(c => c.key === key)?.type === 'date') {
      va = parseDateBR(va)?.getTime() || 0;
      vb = parseDateBR(vb)?.getTime() || 0;
    } else {
      va = String(va || '').toLowerCase();
      vb = String(vb || '').toLowerCase();
    }

    if (va < vb) return asc ? -1 : 1;
    if (va > vb) return asc ? 1 : -1;
    return 0;
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;')
               .replace(/"/g, '&quot;')
               .replace(/'/g, '&#039;');
  }

  // ====== Gr√°ficos (utilizando Chart.js se dispon√≠vel) ======
  function drawCharts() {
    // Seu c√≥digo para desenhar gr√°ficos aqui...
    // Exemplo simplificado: somar valores por status
    if (typeof Chart === 'undefined') return;

    const ctxStatus = document.getElementById('chartStatus')?.getContext('2d');
    if (!ctxStatus) return;

    const statusMap = { 'VALIDADA':0, 'REJEITADA':0, 'JUSTIFICADA':0, 'INATIVADA':0 };
    registros.forEach(r => {
      if (statusMap.hasOwnProperty(r.status)) {
        statusMap[r.status] += parseBRL(r.valor) || 0;
      }
    });

    if (window.statusChart) window.statusChart.destroy();

    window.statusChart = new Chart(ctxStatus, {
      type: 'pie',
      data: {
        labels: Object.keys(statusMap),
        datasets: [{
          data: Object.values(statusMap),
          backgroundColor: ['#4caf50','#f44336','#ff9800','#9e9e9e']
        }]
      },
      options: { responsive:true }
    });
  }
});
</script>

</body>
</html>
